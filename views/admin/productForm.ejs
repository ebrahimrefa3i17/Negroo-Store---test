<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        /* Keep existing styles */
        .image-preview.hidden, .video-preview.hidden {
            display: none;
        }
        .image-preview-container .placeholder-text {
            color: #888;
            text-align: center;
            font-style: italic;
        }

        /* NEW: Styles for Variants Section */
        .variants-section {
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            min-height: 150px; /* تمت الإضافة: لضمان ارتفاع أدنى للقسم */
        }
        .variant-group {
            border: 1px dashed #cccccc;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #fff;
            position: relative;
            min-height: 120px; /* تمت الإضافة: لضمان ارتفاع أدنى لكل مجموعة متغيرات */
        }
        .variant-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .variant-option {
            border: 1px solid #e9e9e9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #fcfcfc;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        .variant-option .form-group {
            flex: 1 1 calc(33% - 20px); /* Adjust width for inputs */
            margin-bottom: 0; /* Remove default margin for inner form-group */
        }
        .variant-option .form-group label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }
        .variant-option .form-control-sm {
            height: calc(1.5em + .75rem + 2px); /* Smaller input height */
            padding: .375rem .75rem;
            font-size: .875rem;
        }
        .remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.2em;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .remove-group-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .variant-option-image-preview {
            max-width: 60px;
            max-height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
            border: 1px solid #eee;
        }
        .variant-option .form-group.image-upload-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1 1 calc(25% - 20px);
        }
        .variant-option .form-group.image-upload-group input[type="file"] {
            font-size: 0.85rem;
            padding: 0.375rem 0;
        }
    </style>
</head>
<body>
    <%- include('../partials/admin-header', { activePage: 'products' }) %>
    <div class="admin-container">
        <h2 class="section-heading"><%= title %></h2>

        <form id="productForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="name" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="5" required></textarea>
            </div>
            <div class="mb-3">
                <label for="price" class="form-label">Price (EGP)</label>
                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
            </div>
            <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category" required>
                    <option value="">Loading categories...</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="stock" class="form-label">Overall Stock Quantity</label>
                <input type="number" class="form-control" id="stock" name="stock" min="0" required>
                <div class="form-text">This is the total stock if no variants are used, or a fallback.</div>
            </div>
            <div class="mb-3">
                <label for="minStockThreshold" class="form-label">Minimum Stock Threshold for Alerts</label>
                <input type="number" class="form-control" id="minStockThreshold" name="minStockThreshold" min="0" value="10">
                <div class="form-text">An alert will be triggered if overall stock falls below this number.</div>
            </div>
            <div class="mb-3">
                <label for="minStockThreshold" class="form-label">Minimum Stock Threshold for Alerts</label>
                <input type="number" class="form-control" id="minStockThreshold" name="minStockThreshold" min="0" value="10">
                <div class="form-text">An alert will be triggered if overall stock falls below this number.</div>
            </div>

            <div class="mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="isOnFlashSale">
                    <label class="form-check-label" for="isOnFlashSale">
                        Is this product on Flash Sale?
                    </label>
                </div>
            </div>

            <div id="flashSaleFieldsContainer" class="hidden border p-3 rounded-lg bg-gray-50 mb-4">
                <h5 class="text-lg font-semibold mb-3">Flash Sale Details</h5>
                <div class="mb-3">
                    <label for="flashSalePrice" class="form-label">Flash Sale Price</label>
                    <input type="number" class="form-control" id="flashSalePrice" step="0.01" min="0">
                </div>
                <div class="mb-3">
                    <label for="flashSaleEndDate" class="form-label">Flash Sale End Date</label>
                    <input type="datetime-local" class="form-control" id="flashSaleEndDate">
                </div>
            </div>
            <div class="variants-section">
                <h3 class="section-sub-heading mb-3"><i class="fas fa-cubes me-2"></i>Product Variants</h3>
                <div id="variantGroupsContainer">
                    <% /* IMPORTANT:
                        The EJS code that previously rendered existing product variants has been removed from here.
                        All existing variant groups and their options will now be dynamically rendered by JavaScript
                        when the page loads in edit mode (via loadProductForEdit function in admin-product-form.js).
                        This prevents duplication issues.
                    */ %>
                </div>
                <button type="button" id="addVariantGroupBtn" class="btn btn-success mt-3">
                    <i class="fas fa-plus-circle me-2"></i>Add New Variant Group
                </button>
            </div>

            <div class="mb-3">
                <label for="mainImageUpload" class="form-label">Main Image/Video</label>
                <input type="file" class="form-control" id="mainImageUpload" name="mainImage" accept="image/*,video/*">
                <div class="image-preview-container border p-2 mt-2 rounded">
                    <img id="mainImagePreview" class="image-preview hidden img-fluid" alt="Main Media Preview">
                    <video id="mainVideoPreview" class="video-preview hidden img-fluid" controls muted loop alt="Main Video Preview"></video>
                    <p id="mainMediaPlaceholder" class="placeholder-text text-muted">Upload main product image or video</p>
                </div>
            </div>
            <div class="mb-3">
                <label for="additionalImagesUpload" class="form-label">Additional Images/Videos (Max 10)</label>
                <input type="file" class="form-control" id="additionalImagesUpload" name="additionalImages" multiple accept="image/*,video/*">
                <div class="image-preview-container border p-2 mt-2 rounded d-flex flex-wrap" id="additionalPreviewsContainer">
                    <p id="additionalMediaPlaceholder" class="placeholder-text text-muted">No additional media selected</p>
                </div>
            </div>

            <div class="mb-3">
                <label for="specifications" class="form-label">Specifications</label>
                <textarea class="form-control" id="specifications" name="specifications" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="shippingAndReturns" class="form-label">Shipping & Returns Information</label>
                <textarea class="form-control" id="shippingAndReturns" name="shippingAndReturns" rows="3"></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-submit"><i class="fas fa-save me-2"></i>Save Product</button>
            <a href="/admin/products" class="btn btn-secondary btn-cancel ms-2">Cancel</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/admin-core.js"></script>
    <script src="/js/admin-product-form.js"></script>
</body>
</html>