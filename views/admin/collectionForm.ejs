<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Livvic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Optional: Add specific styles for category form if needed */
        .image-preview-container {
            border: 1px dashed #ced4da;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 5px;
            /* قم بإزالة display: none; من هنا - تم التعديل مسبقا */
        }
        .image-preview.hidden { /* أضف هذا الجزء الجديد لإخفاء الصورة عندما يكون لديها الكلاس hidden - تم التعديل مسبقا */
            display: none;
        }
        .image-placeholder {
            color: #6c757d;
            font-style: italic;
        }
        .image-placeholder.hidden { /* تأكد من وجودها إذا لم تكن موجودة - تم التعديل مسبقا */
            display: none;
        }
        /* Basic form-group styling for consistency if not using Bootstrap grid */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        .btn-submit, .btn-cancel {
            padding: 0.75rem 1.25rem;
            border-radius: 0.25rem;
            text-decoration: none;
            display: inline-block;
            margin-right: 1rem;
            cursor: pointer;
            border: none;
        }
        .btn-submit {
            background-color: #007bff;
            color: white;
        }
        .btn-submit:hover {
            background-color: #0056b3;
        }
        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }
        .btn-cancel:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <%- include('../partials/admin-header', { activePage: activePage }) %>
    <main class="admin-container">
        <h2 class="section-heading"><%= title %></h2> 

        <form id="collectionForm" enctype="multipart/form-data">
            <input type="hidden" id="collectionId" value="<%= typeof collection !== 'undefined' && collection._id ? collection._id : '' %>">
            
            <div class="form-group">
                <label for="name">Collection Name:</label>
                <input type="text" id="name" name="name" value="<%= typeof collection !== 'undefined' && collection.name ? collection.name : '' %>" required>
            </div>
            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" name="description" rows="3" placeholder="Enter a short description for the collection (optional)"><%= typeof collection !== 'undefined' && collection.description ? collection.description : '' %></textarea>
            </div>
            <div class="form-group">
                <label for="imageUrl">Collection Image (Upload):</label>
                <input type="file" id="imageUrl" name="imageUrl" accept="image/*" class="form-control">
                <small class="form-text text-muted">Upload an image for the collection thumbnail.</small>
                <div class="image-preview-container mt-2">
                    <img id="collectionImagePreview" class="image-preview <%= typeof collection !== 'undefined' && collection.imageUrl ? '' : 'hidden' %>" src="<%= typeof collection !== 'undefined' && collection.imageUrl ? collection.imageUrl : '#' %>" alt="Collection Image Preview">
                    <p id="imagePlaceholder" class="text-muted text-center flex-grow-1 <%= typeof collection !== 'undefined' && collection.imageUrl ? 'hidden' : '' %>">No image selected</p>
                </div>
            </div>

            <div class="form-group">
                <label for="products">Products in this Collection:</label>
                <select class="form-control" id="products" name="products" multiple required>
                    <% allProducts.forEach(product => { %>
                        <option value="<%= product._id %>" 
                            <%= typeof collection !== 'undefined' && collection.products && collection.products.map(p => p.toString()).includes(product._id.toString()) ? 'selected' : '' %>>
                            <%= product.name %>
                        </option>
                    <% }); %>
                </select>
                <small class="form-text text-muted">Select all products that belong to this collection. Hold Ctrl (or Cmd on Mac) to select multiple.</small>
            </div>

            <hr class="my-4">
            <h3>Suggestion Settings (Where this collection might be suggested)</h3>

            <div class="form-group">
                <label for="suggestedOnProducts">Suggest on Specific Products (Optional):</label>
                <select class="form-control" id="suggestedOnProducts" name="suggestedOnProducts" multiple>
                    <% allProducts.forEach(product => { %>
                        <option value="<%= product._id %>" 
                            <%= typeof collection !== 'undefined' && collection.suggestedOnProducts && collection.suggestedOnProducts.map(p => p.toString()).includes(product._id.toString()) ? 'selected' : '' %>>
                            <%= product.name %>
                        </option>
                    <% }); %>
                </select>
                <small class="form-text text-muted">Select product pages where this collection should be explicitly suggested. Hold Ctrl (or Cmd on Mac) to select multiple.</small>
            </div>

            <div class="form-group">
                <label for="suggestedOnCategories">Suggest on Specific Categories (Optional):</label>
                <select class="form-control" id="suggestedOnCategories" name="suggestedOnCategories" multiple>
                    <% if (typeof allCategories !== 'undefined' && allCategories.length > 0) { %>
                        <% allCategories.forEach(category => { %>
                            <option value="<%= category._id %>" 
                                <%= typeof collection !== 'undefined' && collection.suggestedOnCategories && collection.suggestedOnCategories.map(c => c.toString()).includes(category._id.toString()) ? 'selected' : '' %>>
                                <%= category.name %>
                            </option>
                        <% }); %>
                    <% } %>
                </select>
                <small class="form-text text-muted">Select categories whose product pages should suggest this collection. Hold Ctrl (or Cmd on Mac) to select multiple.</small>
            </div>

            <div class="form-group">
                <label for="tags">Tags (Comma-separated, Optional):</label>
                <input type="text" class="form-control" id="tags" name="tags" value="<%= typeof collection !== 'undefined' && collection.tags ? collection.tags.join(', ') : '' %>">
                <small class="form-text text-muted">Enter keywords related to this collection, separated by commas (e.g., kitchen, smart-home).</small>
            </div>
            
            <button type="submit" class="btn-submit me-2"><i class="fas fa-save me-2"></i>Save Collection</button>
            <a href="/admin/collections" class="btn-cancel"><i class="fas fa-times-circle me-2"></i>Cancel</a>
        </form>
    </main>
    
    <%- include('../partials/admin-footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script src="/js/toast.js" type="module"></script>
    <script src="/js/auth.js" type="module"></script>
    <script src="/js/admin-core.js" type="module"></script> <script src="/js/admin-collections.js" type="module"></script>
</body>
</html>